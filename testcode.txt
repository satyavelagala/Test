ALTER procedure [test].[Sp_SaveReportDetails]
(

@ReportsInfo varchar(max) NULL
--,@ErrorCode int out 
)
as
begin


declare  @ErrorCode  int=0

select @ReportsInfo = [value]
 from OpenJson(@ReportsInfo)
 where [key] = 'items'

 select *
 into #Reports 
 from Test.reports
 where 1<>1

    insert into #Reports (ReportGUID,ReportName)
    select ReportGUID,ReportName  
	from openJson(@ReportsInfo)
	with 
	
	(
			 ReportGUID nvarchar(120) '$.id'
			,ReportName nvarchar(40) '$.name'
			
	)
   
   begin try
		begin tran  
		MERGE [Test].[Reports] T 
		USING #Reports S 
		ON (T.ReportName=S.ReportName )
		WHEN  MATCHED  THEN  UPDATE  SET 
		T.UpdatedDate = getdate()
		WHEN NOT MATCHED BY TARGET THEN 
		INSERT   (ReportGUID,ReportName)
		VALUES 
		(S.ReportGUID,S.ReportName);
		commit
   end try
   begin catch
		rollback 
		set @ErrorCode = 500
   end catch
end
